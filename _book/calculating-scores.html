<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Ocean Health Index Toolbox Training</title>
  <meta name="description" content="This is the official Ocean Health Index Toolbox training.">
  <meta name="generator" content="bookdown 0.3.9 and GitBook 2.6.7">

  <meta property="og:title" content="Ocean Health Index Toolbox Training" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is the official Ocean Health Index Toolbox training." />
  <meta name="github-repo" content="ohi-science/ohi-trainings" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Ocean Health Index Toolbox Training" />
  
  <meta name="twitter:description" content="This is the official Ocean Health Index Toolbox training." />
  

<meta name="author" content="Ocean Health Index Team">


<meta name="date" content="2017-02-15">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="preparing-data.html">
<link rel="next" href="updating-your-website.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Overview</a></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a></li>
<li class="chapter" data-level="3" data-path="data-science-workflow.html"><a href="data-science-workflow.html"><i class="fa fa-check"></i><b>3</b> Data science workflow</a></li>
<li class="chapter" data-level="4" data-path="toolbox-ecosystem.html"><a href="toolbox-ecosystem.html"><i class="fa fa-check"></i><b>4</b> Toolbox Ecosystem</a></li>
<li class="chapter" data-level="5" data-path="preparing-data.html"><a href="preparing-data.html"><i class="fa fa-check"></i><b>5</b> Preparing data</a></li>
<li class="chapter" data-level="6" data-path="calculating-scores.html"><a href="calculating-scores.html"><i class="fa fa-check"></i><b>6</b> Calculating scores</a><ul>
<li class="chapter" data-level="6.1" data-path="index.html"><a href="index.html#overview"><i class="fa fa-check"></i><b>6.1</b> Overview</a><ul>
<li class="chapter" data-level="6.1.1" data-path="calculating-scores.html"><a href="calculating-scores.html#prerequisites"><i class="fa fa-check"></i><b>6.1.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="calculating-scores.html"><a href="calculating-scores.html#remind-yourself-of-the-toolbox-file-ecosystem"><i class="fa fa-check"></i><b>6.2</b> Remind yourself of the Toolbox file ecosystem</a></li>
<li class="chapter" data-level="6.3" data-path="calculating-scores.html"><a href="calculating-scores.html#the-calculate_scores.r-workflow"><i class="fa fa-check"></i><b>6.3</b> The <code>calculate_scores.r</code> workflow</a><ul>
<li class="chapter" data-level="6.3.1" data-path="calculating-scores.html"><a href="calculating-scores.html#run-install_ohicore.r"><i class="fa fa-check"></i><b>6.3.1</b> run <code>install_ohicore.r</code></a></li>
<li class="chapter" data-level="6.3.2" data-path="calculating-scores.html"><a href="calculating-scores.html#region2016calculate_scores.r"><i class="fa fa-check"></i><b>6.3.2</b> region2016/calculate_scores.r</a></li>
<li class="chapter" data-level="6.3.3" data-path="calculating-scores.html"><a href="calculating-scores.html#recap-of-what-just-happened"><i class="fa fa-check"></i><b>6.3.3</b> Recap of what just happened</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="calculating-scores.html"><a href="calculating-scores.html#update-a-data-layer-and-lets-see-the-whole-process-again."><i class="fa fa-check"></i><b>6.4</b> Update a data layer and let’s see the whole process again.</a><ul>
<li class="chapter" data-level="6.4.1" data-path="calculating-scores.html"><a href="calculating-scores.html#rerun-calculate_scores.r"><i class="fa fa-check"></i><b>6.4.1</b> rerun calculate_scores.r</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="calculating-scores.html"><a href="calculating-scores.html#configure_toolbox.r"><i class="fa fa-check"></i><b>6.5</b> <code>configure_toolbox.r</code></a><ul>
<li class="chapter" data-level="6.5.1" data-path="calculating-scores.html"><a href="calculating-scores.html#loads-libraries"><i class="fa fa-check"></i><b>6.5.1</b> loads libraries</a></li>
<li class="chapter" data-level="6.5.2" data-path="calculating-scores.html"><a href="calculating-scores.html#ohicoreconf"><i class="fa fa-check"></i><b>6.5.2</b> <code>ohicore::Conf()</code></a></li>
<li class="chapter" data-level="6.5.3" data-path="calculating-scores.html"><a href="calculating-scores.html#ohicorechecklayers"><i class="fa fa-check"></i><b>6.5.3</b> <code>ohicore::CheckLayers()</code></a></li>
<li class="chapter" data-level="6.5.4" data-path="calculating-scores.html"><a href="calculating-scores.html#ohicorelayers"><i class="fa fa-check"></i><b>6.5.4</b> <code>ohicore::Layers()</code></a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="calculating-scores.html"><a href="calculating-scores.html#explore-a-goal-model-in-functions.r"><i class="fa fa-check"></i><b>6.6</b> Explore a goal model in <code>functions.r</code></a><ul>
<li class="chapter" data-level="6.6.1" data-path="calculating-scores.html"><a href="calculating-scores.html#load-specific-data-layers-with-selectlayersdata"><i class="fa fa-check"></i><b>6.6.1</b> Load specific data layers with <code>SelectLayersData()</code></a></li>
<li class="chapter" data-level="6.6.2" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate-status"><i class="fa fa-check"></i><b>6.6.2</b> Calculate status</a></li>
<li class="chapter" data-level="6.6.3" data-path="calculating-scores.html"><a href="calculating-scores.html#calculate-trend"><i class="fa fa-check"></i><b>6.6.3</b> Calculate trend</a></li>
<li class="chapter" data-level="6.6.4" data-path="calculating-scores.html"><a href="calculating-scores.html#combine-status-and-trend-scores"><i class="fa fa-check"></i><b>6.6.4</b> Combine status and trend scores</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="calculating-scores.html"><a href="calculating-scores.html#update-goal-model-with-the-original-data-layers"><i class="fa fa-check"></i><b>6.7</b> Update goal model with the original data layers</a></li>
<li class="chapter" data-level="6.8" data-path="calculating-scores.html"><a href="calculating-scores.html#update-goal-model-by-adding-new-layers"><i class="fa fa-check"></i><b>6.8</b> Update goal model by adding new layers</a></li>
<li class="chapter" data-level="6.9" data-path="calculating-scores.html"><a href="calculating-scores.html#todiscuss-ongoing-list"><i class="fa fa-check"></i><b>6.9</b> TODISCUSS ongoing list</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="updating-your-website.html"><a href="updating-your-website.html"><i class="fa fa-check"></i><b>7</b> Updating your website</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Ocean Health Index Toolbox Training</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="calculating-scores" class="section level1">
<h1><span class="header-section-number">Chapter 6</span> Calculating scores</h1>
<div id="overview" class="section level2">
<h2><span class="header-section-number">6.1</span> Overview</h2>
<p>This is a 2-hour hands-on training. All training materials are below, and can also serve as a self-paced workshop without in-person instruction.</p>
<p>TODO <code>@jules32</code>: This chapter will take you from prepared data to calculated scores. It requires book keeping, <code>R</code> functions, and ultimately, the <code>R</code> package <code>ohicore</code>… In this chapter we’re going to - single goal model with updated data, basically line-by-line to understand the architecture of goal models (access the correct data layers, calc status, calc trend, make sure the final output is standard for what the <code>scores variables</code> need. - then calculate all goal models and scores, including pressures, and resilience. - introduce which data layer we modified and which goal model we are using as an example AO - a lot of shuffling and bookkeeping. - runs the status, trend in functions.r, but also calculates pressures, resilience, lfs, and overall scores. - score.csv updated, check that in Git tab of RStudio</p>
<div id="prerequisites" class="section level3">
<h3><span class="header-section-number">6.1.1</span> Prerequisites</h3>
<p>Before you begin, do the following:</p>
<ol style="list-style-type: decimal">
<li>Make sure you have RStudio and GitHub setup (Chapter <a href="#workflow"><strong>??</strong></a>), with an up-to-date version of R and RStudio</li>
<li>Fork the <a href="https://github.com/OHI-Science/toolbox-demo"><strong>toolbox-demo</strong></a> repository into your own GitHub account (click Fork in the upper right corner, and select your account)</li>
<li>Clone the <strong>toolbox-demo</strong> repo from your GitHub account into RStudio (Chapter X)</li>
<li>Get comfortable: be set up in a way so that you can see this tutorial and your RStudio window (maybe 2 screens, maybe switching between programs).</li>
</ol>
</div>
</div>
<div id="remind-yourself-of-the-toolbox-file-ecosystem" class="section level2">
<h2><span class="header-section-number">6.2</span> Remind yourself of the Toolbox file ecosystem</h2>
<p>Chapter <a href="toolbox-ecosystem.html#toolbox-ecosystem">4</a></p>
<p>In the <strong>toolbox-demo</strong> repo, we have a scenario folder called <strong>region2016</strong>.</p>
</div>
<div id="the-calculate_scores.r-workflow" class="section level2">
<h2><span class="header-section-number">6.3</span> The <code>calculate_scores.r</code> workflow</h2>
<p><code>calculate_scores.r</code> is a script that you’ll run a lot - in its entirety and piece-by-piece. It will load the libraries you need, check your book keeping and configure everything for <code>ohicore</code>, calculate OHI scores by calculating the required dimensions in a specific order (see below) and ultimately save scores for each goal and dimension in <code>scores.csv</code>.</p>
<blockquote>
<p>OHI ‘dimensions’ are status, trend, pressures, resilience, likely future state, and scores, and are calculated for each goal.</p>
</blockquote>
<p>follow along, we’re doing this together…</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1uMcbzmBRgjxKVgRqLYnxpbOGIJrm1AbMw7D3E-dUFzk/pub?w=960&amp;h=720" />

</div>
<div id="run-install_ohicore.r" class="section level3">
<h3><span class="header-section-number">6.3.1</span> run <code>install_ohicore.r</code></h3>
<p><code>ohicore</code> is an R package developed by the OHI team that has all the essential functions and supporting packages you will use to develop your assessment and calculate scores. By installing <code>ohicore</code> and calling it from the <code>toolbox-training</code> repository, you gain access to all those functions and packages. Learn more about <code>ohicore</code> in Chapter X.</p>
</div>
<div id="region2016calculate_scores.r" class="section level3">
<h3><span class="header-section-number">6.3.2</span> region2016/calculate_scores.r</h3>
<p>TODO <code>@ningningj</code>: Open <code>calculate_scores.r</code> by navigating to it in the <code>region2016</code> folder and clicking on it.</p>
<ul>
<li>comments up top to help explain</li>
<li><p>requires ohicore.</p></li>
<li><p>run line-by-line, explain warning messages. The order that CalculateAll() operates: YOUR goal models (status + trend) in functions.r, pressures and resilience based on YOUR matrix tables, Likely Future State and Scores (combo of the above)</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## run the configure_toolbox.r script to check configuration
<span class="kw">source</span>(<span class="st">&#39;~/github/toolbox-demo/region2016/configure_toolbox.r&#39;</span>)

<span class="co"># ...</span>
<span class="co">#   tr_travelwarnings</span>
<span class="co"># Warning messages:</span>
<span class="co"># 1: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :</span>
<span class="co">#   Unused fields...</span>
<span class="co">#     ico_spp_iucn_status: iucn_sid</span>
<span class="co"># 2: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :</span>
<span class="co">#   Rows duplicated...</span>
<span class="co">#     ico_spp_iucn_status: 816</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## calculate scenario scores
scores =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">CalculateAll</span>(conf, layers)

<span class="co"># Running Setup()...</span>
<span class="co"># Calculating Status and Trend for each region for FIS...</span>
<span class="co"># Calculating Status and Trend for each region for MAR...</span>
<span class="co"># 95th percentile for MAR ref pt is: 0.0758396517531756</span>
<span class="co"># ...</span>
<span class="co"># Calculating Pressures for each region...</span>
<span class="co"># There are 6 pressures subcategories: pollution, alien_species, habitat_destruction, fishing_pressure, climate_change, social </span>
<span class="co"># These goal-elements are in the weighting data layers, but not included in the pressure_matrix.csv:</span>
<span class="co"># LIV-aqf</span>
<span class="co"># These goal-elements are in the pressure_matrix.csv, but not included in the weighting data layers:</span>
<span class="co"># CP-coral, CP-mangrove, CP-saltmarsh, CS-mangrove, CS-saltmarsh, HAB-coral, HAB-mangrove, HAB-saltmarsh, HAB-seagrass, LIV-ph, LIV-tran, CP-seaice_shoreline, HAB-seaice_edge, ECO-wte, LIV-wte, LIV-sb</span>
<span class="co"># Calculating Resilience for each region...</span>
<span class="co"># There are 7 Resilience subcategories: ecological, alien_species, goal, fishing_pressure, habitat_destruction, pollution, social </span>
<span class="co"># These goal-elements are in the resilience_matrix.csv, but not included in the weighting data layers:</span>
<span class="co"># CP-coral, CP-saltmarsh, CS-saltmarsh, HAB-coral, HAB-saltmarsh, HAB-seagrass, CP-mangrove, CS-mangrove, HAB-mangrove, HAB-seaice_edge, CP-seaice_shoreline</span>
<span class="co"># ...</span>
<span class="co"># Calculating Goal Score and Likely Future for each region for FIS...</span>
<span class="co"># Calculating Goal Score and Likely Future for each region for MAR...</span>
<span class="co"># ...Calculating post-Index function for each region for FP...</span>
<span class="co"># Calculating post-Index function for each region for LE...</span>
<span class="co"># Calculating Index score for each region for supragoals using goal weights...</span>
<span class="co"># Calculating Likely Future State for each region for supragoals using goal weights...</span>
<span class="co"># Calculating Post-process PreGlobalScores() function for each region...</span>
<span class="co"># Calculating scores for ASSESSMENT AREA (region_id=0) by area weighting...</span>
<span class="co"># Calculating FinalizeScores function...</span></code></pre></div>
<p>And the warning messages:</p>
<pre><code>Warning messages:
1: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
2: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
3: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factors with different levels, coercing to character vector
4: In left_join_impl(x, y, by$x, by$y, suffix$x, suffix$y) :
  joining factor and character vector, coercing into character vector
5: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
6: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf
7: In min(d$x, na.rm = T) : no non-missing arguments to min; returning Inf
8: In max(d$x, na.rm = T) :
  no non-missing arguments to max; returning -Inf</code></pre>
</div>
<div id="recap-of-what-just-happened" class="section level3">
<h3><span class="header-section-number">6.3.3</span> Recap of what just happened</h3>
<p>TODO <code>jules32</code>: add text here</p>
<p>Hopefully this first time you haven’t encountered error messages, but you definitely will as you move ahead. Error messages are often due to typos or operations you are carrying out in <code>R</code>. Error messages often try to alert you to what went wrong, and we are continually improving error messages you’ll encounter when you use <code>ohicore</code> so you can try to solve them. Some commonly occurring errors and how to fix them can be found in the Troubleshooting section of the manual. Copy-pasting error messages into Google is also a great aproach.</p>
</div>
</div>
<div id="update-a-data-layer-and-lets-see-the-whole-process-again." class="section level2">
<h2><span class="header-section-number">6.4</span> Update a data layer and let’s see the whole process again.</h2>
<p>TODO <code>@ningningj</code>:</p>
<p>In this example, we will substitute a single global data layer with the same layername (although different data file) with local data and recalculate scores without modifying the goal model itself. The <a href="#update"><strong>??</strong></a> chapter will show an example for updating goal models.</p>
<p>TODO - make a short, fake prep_AO.R. with last step: save in layers folder. (probably keep it simple, not as a full .Rmd. and <a href="https://github.com/OHI-Science/toolbox-demo/blob/master/region2016/spatial/regions_list.csv">here</a> are the regions for the toolbox-demo repo. - and register it too, briefly.</p>
<p>Ning: anything else we should show here from your <a href="https://github.com/OHI-Science/tutorials/tree/gh-pages/data_prep_non_spatial">data prep tutorial</a>, or should that all go in Chapter 5?</p>
<div id="rerun-calculate_scores.r" class="section level3">
<h3><span class="header-section-number">6.4.1</span> rerun calculate_scores.r</h3>
<ul>
<li>see that now <code>scores.csv</code> shows up in the git window. Great way to check your work. Which goal do you expect to change?</li>
<li>and layers.csv, and your layers file</li>
</ul>
<p><strong>Checking your work:</strong> Whenever there are changes made (addition, deletion, changes in .csv or r script), you will be notified in the Git window, since Git is tracking changes to your work. So here, since you added a new data layer, and also expect changes to AO scores in <code>score.csv</code>. This is a good place to double check whether you have made the right changes.</p>
</div>
</div>
<div id="configure_toolbox.r" class="section level2">
<h2><span class="header-section-number">6.5</span> <code>configure_toolbox.r</code></h2>
<p>So now let’s take a closer look, let’s check out configure_toolbox.r, the first thing that runs.</p>
<p><code>configure_toolbox.r</code> combines everything required to calculate OHI scores and checks that they are properly formatted, and will minimize potential errors later on. It makes sure that your data and goal models are ready to be used to calculate scores.</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1WvHfWe06D2x9cKB7vhWrmvmxuRpmGvzsMs9AjS23g3E/pub?h=450" />

</div>
<blockquote>
<p>Any time you make a change to a data layer or a goal model and want to recalculate scores, you will need to re-run <code>configure_toolbox.r</code> to have ohicore operate on the most up-to-date information. You can click “Source” to run all the lines:</p>
</blockquote>
<blockquote>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1JvSJKyiwvp92--obTwHT3IYht1XE0823sORJ4FdnX74/pub?h=450" />

</div>
</blockquote>
<div id="loads-libraries" class="section level3">
<h3><span class="header-section-number">6.5.1</span> loads libraries</h3>
<p>TODO: write (also, if you are requiring other libraries, this would be the place to put them)</p>
</div>
<div id="ohicoreconf" class="section level3">
<h3><span class="header-section-number">6.5.2</span> <code>ohicore::Conf()</code></h3>
<p>This step links together all the data layers (for goal, pressures, resilience), goal functions, and other OHI parameters that determines how ohi scores are calculated. TODO: more</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## load scenario configuration
conf =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">Conf</span>(<span class="st">&#39;conf&#39;</span>)

<span class="co"># (no output). </span></code></pre></div>
</div>
<div id="ohicorechecklayers" class="section level3">
<h3><span class="header-section-number">6.5.3</span> <code>ohicore::CheckLayers()</code></h3>
<p>This function checks that data layers are properly formatted and registered, and returns a list of all of the layers that are registered. Check to make sure ours is there. This is a gate-keeping step by to make sure the data layers you’ve entered are in the right format and can be read by <code>ohicore</code> properly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## check that scenario layers files in the \layers folder match layers.csv registration. Layers files are not modified.
ohicore<span class="op">::</span><span class="kw">CheckLayers</span>(<span class="st">&#39;layers.csv&#39;</span>, <span class="st">&#39;layers&#39;</span>, <span class="dt">flds_id=</span>conf<span class="op">$</span>config<span class="op">$</span>layers_id_fields)</code></pre></div>
<p>Warning messages alert you to problems with specific layers: this is showing that there are duplicates in a status layer. These warning messages are not a problem now (they are a byproduct of extracting this repo based on Global OHI assessments; you’ll be changing this layer anyways).</p>
<pre><code>Warning messages:
1: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :
  Unused fields...
    ico_spp_iucn_status: iucn_sid
2: In ohicore::CheckLayers(&quot;layers.csv&quot;, &quot;layers&quot;, flds_id = conf$config$layers_id_fields) :
  Rows duplicated...
    ico_spp_iucn_status: 816</code></pre>
<p>You’ll also encounter error messages as you develop your own assessment. These messages intend to alert you that there are errors in data entry. Some common errors are:</p>
<ul>
<li>improper formatting or missing columns in your data layer</li>
<li>typos or misnamed columns</li>
</ul>
</div>
<div id="ohicorelayers" class="section level3">
<h3><span class="header-section-number">6.5.4</span> <code>ohicore::Layers()</code></h3>
<p>TODO: explain</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## load scenario layers for ohicore to access. Layers files are not modified.
layers =<span class="st"> </span>ohicore<span class="op">::</span><span class="kw">Layers</span>(<span class="st">&#39;layers.csv&#39;</span>, <span class="st">&#39;layers&#39;</span>)

<span class="co"># (no output)</span></code></pre></div>
</div>
</div>
<div id="explore-a-goal-model-in-functions.r" class="section level2">
<h2><span class="header-section-number">6.6</span> Explore a goal model in <code>functions.r</code></h2>
<p>TODO <code>@ningningj</code>: (I’ve moved this over here but make sure it still makes sense):</p>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1CKNjIORLJOEaV2XW4Z9QuFLN7q1lJ1PaEGg2dSG1-_o/pub?h=450" />

</div>
<p>Remember from <code>calculate_scores.r</code> that after configure_toolbox, the next thing that happens is that CalculateScores() runs through the goal models and calcuates status and trend.</p>
<p>Open <code>functions.r</code>. <code>functions.r</code> is a big list of all goal models in the assessment, each as its own <code>R</code> function. You can run all of them at the once or each individually. <strong>Each goal model is an individual R function that calculates status and trend, and you will modify the goal model within the confines of each function</strong>. Let’s look at the goal models for Artisanal Fishing Opportunity (AO) as an example. It has models developed from the most recent global assessment as a place for you to start.</p>
<blockquote>
<p><strong>Tip</strong>: Clicking the bottom left corner of Console will show you a drop-down menu of all functions. It’s a shortcut to jump to the appropriate section or goal model</p>
</blockquote>
<blockquote>
<div class="figure">
<img src="https://docs.google.com/drawings/d/1Z2AVtVfIZEd_5GDcmaLb8mRpErKTDzmcbg0SBMxKsxs/pub?h=450" />

</div>
</blockquote>
<p>The following things happen in each goal model:</p>
<ul>
<li>load specific data layers (using <code>ohicore::SelectLayersData()</code>)</li>
<li>calculate status scores</li>
<li>calculate trend scores</li>
<li>combine status and trend scores</li>
<li>format and return the <code>scores</code></li>
</ul>
<div id="load-specific-data-layers-with-selectlayersdata" class="section level3">
<h3><span class="header-section-number">6.6.1</span> Load specific data layers with <code>SelectLayersData()</code></h3>
<p><code>SelectLayersData()</code> is an <code>ohicore</code> function to call the appropriate data layers by its layer name registered in <code>layers.csv</code> (eg. “ao_access”) Run this chunk of code and the data layers will be loaded, joined, and ready to be manipulated further:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## &quot;select&quot;&quot; is a function from the dplyr package to let you select only the columns you would need

r &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_access&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id=</span>id_num, <span class="dt">access=</span>val_num)
r &lt;-<span class="st"> </span><span class="kw">na.omit</span>(r)

ry &lt;-<span class="st"> </span><span class="kw">SelectLayersData</span>(layers, <span class="dt">layers =</span> <span class="st">&#39;ao_need&#39;</span>, <span class="dt">narrow=</span><span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="dt">region_id =</span> id_num, year, <span class="dt">need=</span>val_num) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">left_join</span>(r, <span class="dt">by=</span><span class="st">&quot;region_id&quot;</span>)</code></pre></div>
<blockquote>
<p>Tip: it’s always a good idea to check what your data looks like and make sure there are no glaring errors. A couple of commonly used functions are: head() and str()</p>
</blockquote>
</div>
<div id="calculate-status" class="section level3">
<h3><span class="header-section-number">6.6.2</span> Calculate status</h3>
<p>Once you make sure your raw data have been loaded and joined in the right format, you can start calculate status scores!</p>
<p><strong>TODO <code>@ningningj</code>: this syntax uses the <code>tidyverse</code> and chaining…look xxx to learn more</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># model: this step calculates status scores of all years, using the goal model. </span>

## &quot;mutate&quot; is another commonly used function from dplyr that allows you to add a new column to the data frame
## Note that &quot;Sustainability&quot; and &quot;status_year&quot; have been defined at the start of the AO function 
  Sustainability=<span class="fl">1.0</span>
  status_year =<span class="st"> </span><span class="dv">2015</span>

  ry &lt;-<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">Du =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>need) <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>access)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status =</span> (<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>Du) <span class="op">*</span><span class="st"> </span>Sustainability)

<span class="co"># status: status scores are typically the most recent year of all the years you have calculated. </span>

  r.status &lt;-<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(year<span class="op">==</span>status_year) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(region_id, status) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">status=</span>status<span class="op">*</span><span class="dv">100</span>)</code></pre></div>
</div>
<div id="calculate-trend" class="section level3">
<h3><span class="header-section-number">6.6.3</span> Calculate trend</h3>
<p>Trend scores are typically based on linear regression of status scores from the most recent five years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="co"># choose trend years (eg. most recent five years)</span>

  trend_years &lt;-<span class="st"> </span>(status_year<span class="op">-</span><span class="dv">4</span>)<span class="op">:</span>(status_year)
  adj_trend_year &lt;-<span class="st"> </span><span class="kw">min</span>(trend_years)

  r.trend =<span class="st"> </span>ry <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(region_id) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># linear model: </span>
<span class="st">    </span><span class="kw">do</span>(<span class="dt">mdl =</span> <span class="kw">lm</span>(status <span class="op">~</span><span class="st"> </span>year, <span class="dt">data=</span>., <span class="dt">subset=</span>year <span class="op">%in%</span><span class="st"> </span>trend_years),
       <span class="dt">adjust_trend =</span> .<span class="op">$</span>status[.<span class="op">$</span>year <span class="op">==</span><span class="st"> </span>adj_trend_year]) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># extract the coefficient of year and produce a trend score</span>
<span class="st">    </span><span class="kw">summarize</span>(region_id, <span class="dt">trend =</span> <span class="kw">ifelse</span>(<span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]<span class="op">==</span><span class="dv">0</span>, <span class="dv">0</span>, <span class="kw">coef</span>(mdl)[<span class="st">&#39;year&#39;</span>]<span class="op">/</span>adjust_trend <span class="op">*</span><span class="st"> </span><span class="dv">5</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="co"># make sure that the scores are between -1 and 1</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend<span class="op">&gt;</span><span class="dv">1</span>, <span class="dv">1</span>, trend)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">ifelse</span>(trend<span class="op">&lt;</span>(<span class="op">-</span><span class="dv">1</span>), (<span class="op">-</span><span class="dv">1</span>), trend)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">trend =</span> <span class="kw">round</span>(trend, <span class="dv">4</span>))</code></pre></div>
</div>
<div id="combine-status-and-trend-scores" class="section level3">
<h3><span class="header-section-number">6.6.4</span> Combine status and trend scores</h3>
<p>Choose only region_id and score, and add two more columns identifying score dimension (status or trend) and goal name.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> scores =<span class="st"> </span>r.status <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>status) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;status&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rbind</span>(
      r.trend <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">select</span>(region_id, <span class="dt">score=</span>trend) <span class="op">%&gt;%</span>
<span class="st">        </span><span class="kw">mutate</span>(<span class="dt">dimension=</span><span class="st">&#39;trend&#39;</span>)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">goal=</span><span class="st">&#39;AO&#39;</span>)</code></pre></div>
</div>
</div>
<div id="update-goal-model-with-the-original-data-layers" class="section level2">
<h2><span class="header-section-number">6.7</span> Update goal model with the original data layers</h2>
<p>TODO <code>@jules32</code></p>
</div>
<div id="update-goal-model-by-adding-new-layers" class="section level2">
<h2><span class="header-section-number">6.8</span> Update goal model by adding new layers</h2>
<p>TODO <code>@jules32</code></p>
<ul>
<li>add a new row to layers.csv</li>
<li>use SelectLayersData() to access your new layer, and then use it in a calculation.</li>
</ul>
<p>end 2-hour tutorial.</p>
</div>
<div id="todiscuss-ongoing-list" class="section level2">
<h2><span class="header-section-number">6.9</span> TODISCUSS ongoing list</h2>
<ul>
<li><a href="https://docs.google.com/drawings/d/1MAIgSAFUTFg2J9XKIYBUFttOfHex5OSMbXIDlUMlKSY/pub?h=500">this workflow figure</a>, do we need it anymore?
<ul>
<li><strong>TODO <code>@ningningj</code>: this figure may be more clear here if the red boxes are removed and instead placed around the green top pieces “modify goal models” and “calculate scores”?</strong> <code>@jules32</code>: i didn’t do that because we are not updating pressures and resilience. but your point is totally valid. i updated the figure as below, highlighting only the steps and scripts used here. what do you think?</li>
</ul></li>
</ul>
<!---next step after Eva training: 

- PlotFlower, PlotMap
- updating pressures/resilience matrices


--->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="preparing-data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="updating-your-website.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
